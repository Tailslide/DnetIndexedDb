@page "/"
@using DnetIndexedDb.Blob
@using System.Diagnostics
@using System.Text.Json
@using System.Text
@*@inject IHttpClientFactory ClientFactory*@

@inject IJSRuntime JSRuntime
@inject BlobDb  BlobDb

<div class="dnet-desktop-content destok-layout" style="padding-top: 10px;">
    <div class="row" style="height: calc(100% - 0px)">
        <div class="col-12" style="height: calc(100% - 0px);">
            <div style="height: calc(100% - 0px); width: 100%; background-color: #FFFFFF">
                <span>Thanks for your interest in DnetIndexedDb!. Go to Index.razor and debug</span>
                <button @onclick="TestBlob">Click to load test generated blob or </button>

            <div class="dropArea @dropClass">
                Drag and drop your pictures here or click to open file loading dialogue...
                <InputFile id="inputDrop" 
                           OnChange="@HandleSelected"
                           @ondragenter="HandleDragEnter"
                           @ondragleave="HandleDragLeave"
                           multiple />
            </div>
            <input type="checkbox" id="base64" name="math" value="add" @bind="SaveBase64" />
<label for="base64">Save/Load a Copy as Base64</label>
            <button @onclick="ClearDisplay">Clear Display</button>
            <button @onclick="LoadFromDb">Load Base 64 Pics From IndexDb</button>
            <button @onclick="BinaryLoadFromDb">Load Binary Pics From IndexDb</button>
            <button @onclick="DirectShow">Directly show blob From IndexDb</button>
            <div>&nbsp;</div>
            <img id="testshow1" />
            <img id="testshow2" />
            <img id="testshow3" />
            <img id="testshow4" />
            <img id="testshow5" />
            <img id="testshow6" />
            <img id="testshow7" />
            <img id="testshow8" />
            <img id="testshow9" />
            <img id="testshow10" />
            @foreach (var message in Messages)
            {
                <div>@message</div>
            }

            @foreach (var pic in Pics)
            {
                <img src="@pic" />
            }
            </div>
        </div>
    </div>
</div>

@code {
    public bool SaveBase64 { get; set; } = false;
    public List<string> Messages { get; set; } = new List<string>();
    public List<string> Pics { get; set; } = new List<string>(); //base64 encoded
    public List<(byte[],string )> BinaryPics { get; set; } = new List<( byte[], string)>(); // binary
    string dropClass = string.Empty;

    private void HandleDragEnter()
    {
        dropClass = "dropAreaDrug";
    }
    private void HandleDragLeave()
    {
        dropClass = string.Empty;
    }
    private void ClearDisplay()
    {
        Messages.Clear();
        Pics.Clear();
        BinaryPics.Clear();
    }

    private async Task DirectShow()
    {
        var db1Result = await BlobDb.OpenIndexedDb();
        Stopwatch sw = new Stopwatch();
        sw.Start();

        if (db1Result != -1)
        {
            int counter = 0;
            bool ok = true;
            while (ok)
            {
                counter++;
                string key = counter.ToString() + "-binary";
                try
                {
                    var res = await BlobDb.AssignBlobToElement("BlobStore", key, "testshow" + counter.ToString(),"src");
                    Messages.Add($"Direct showed Blob {key}");
                }
                catch (JSException ex)
                {
                    ok = false;
                    // TODO: Better error checking
                    if (! ex.Message.Contains("Failed to execute 'createObjectURL' on 'URL'"))
                        Messages.Add(ex.ToString());
                }
            }
            Messages.Add($"Showed binary blobs in {sw.ElapsedMilliseconds}ms ");
        }             
    }

   /// <summary>
    /// Faster load from DB, writes directly into .NET memory from javascript
    /// </summary>
    /// <returns></returns>
    private async Task BinaryLoadFromDb()
    {
        var buffer = new byte[10485760]; // 10Mb max.. TODO: have second call to determine size of buffer needed?
        int bytecount = 0;
        var db1Result = await BlobDb.OpenIndexedDb();
            Stopwatch sw = new Stopwatch();
            sw.Start();
        if (db1Result != -1)
        {
            int counter = 0;
            bool ok = true;
            while (ok)
            {
                counter++;
               
                string key = counter.ToString() + "-binary";
                if (SaveBase64) key = counter.ToString() + "-base64";
                try
                {
                    Messages.Add($"Loading record {key}");
                    int res = await BlobDb.GetBlobByKey("BlobStore", key,buffer,10485760);
                    if (res == -1) 
                        ok=false;
                    else
                    {
                        bytecount = res;
                        Messages.Add($"Loaded Blob length={res} first three bytes = {buffer[0]} {buffer[1]} {buffer[2]}");
                        //StateHasChanged();
                    }
                }
                catch (JSException ex)
                {
                    ok = false;
                    // TODO: Better error checking
                    if (! ex.Message.Contains("parameter 1 is not of type 'Blob'"))
                        Messages.Add(ex.ToString());
                }
            }
            Messages.Add($"Got binary blobs in {sw.ElapsedMilliseconds}ms ");
            sw.Restart();
            string pic;
            if (SaveBase64) 
                pic = Encoding.ASCII.GetString(buffer,0,bytecount); // blob was saved already converted to base64
            else
                pic= $"data:image;base64,{System.Convert.ToBase64String(buffer,0,bytecount)}"; //blob in binary format
            
            Messages.Add($"Converted binary blobs in {sw.ElapsedMilliseconds}ms ");
            StateHasChanged();
            await Task.Delay(100);//get the UI to paint before loading
            //Console.WriteLine(pic);

            Pics.Add(pic);
        }        
    }
    /// <summary>
    /// Loading from DB is very slow since we have to marshall data coming back from javascript (but not going to javascript)
    /// </summary>
    /// <returns></returns>
    private async Task LoadFromDb()
    {
        var db1Result = await BlobDb.OpenIndexedDb();
            Stopwatch sw = new Stopwatch();
            sw.Start();
        if (db1Result != -1)
        {
            int counter = 0;
            bool ok = true;
            while (ok)
            {
                counter++;
                string key = counter.ToString() + "-binary";
                try
                {
                    string blob = await BlobDb.GetBlobByKey("BlobStore", key);
                    //Console.WriteLine(blob);
                    Pics.Add(blob);
                    Messages.Add($"Loaded Blob {key}");
                }
                catch (JSException ex)
                {
                    ok = false;
                    // TODO: Better error checking
                    if (! ex.Message.Contains("parameter 1 is not of type 'Blob'"))
                        Messages.Add(ex.ToString());
                }
            }
            Messages.Add($"Got binary blobs in {sw.ElapsedMilliseconds}ms ");
        }        
    }

    private async Task TestBlob()
    {
        var db1Result = await BlobDb.OpenIndexedDb();  
        if (db1Result != -1)
        {
            byte[] Blob = new byte[	5242880];
            //optionally randomize all the bytes
            //Random rnd = new Random();
            //rnd.NextBytes(Blob);
            var db1Resultdel = BlobDb.DeleteAll("BlobStore");
            Stopwatch sw = new Stopwatch();
            sw.Start();
            var db1Result1 = BlobDb.AddBlobItem<byte[]>("BlobStore", Blob, "","firstrecord");
            Messages.Add($"Added 5Mb blob to store in {sw.ElapsedMilliseconds} ms");
            StateHasChanged();
            await Task.Delay(1);
            sw.Restart();
            byte[] buffer = new byte[5242880];
            var blob2 = await BlobDb.GetBlobByKey("BlobStore", "firstrecord",buffer,5242880);
            Messages.Add($"Got blob with (shared buffer) method in {sw.ElapsedMilliseconds}ms ");
            StateHasChanged();
            await Task.Delay(1);
            sw.Restart();
            string blob = await BlobDb.GetBlobByKey("BlobStore", "firstrecord");
            Messages.Add($"Got blob using marshalling in {sw.ElapsedMilliseconds}ms ");
        }
    }

    private async Task HandleSelected(InputFileChangeEventArgs e)
    {
        Stopwatch sw = new Stopwatch();
        var imageFiles = e.GetMultipleFiles(999);
        int id = 0;
        foreach (var imageFile in imageFiles)
        {
            if (imageFile != null)
            {
                IBrowserFile useFile = imageFile;
                
                sw.Start();
                using (var ms = useFile.OpenReadStream(useFile.Size))
                {
                    //var content = new MultipartFormDataContent();
                    //content.Headers.ContentDisposition = new ContentDispositionHeaderValue("form-data");
                    //content.Add(new StreamContent(ms, Convert.ToInt32(resizedFile.Size)), "image", imageFile.Name);
                    byte[] buffer = new byte[useFile.Size];
                    await ms.ReadAsync(buffer);
                    Messages.Add($"Read file name {imageFile.Name} size {imageFile.Size}, content type { imageFile.ContentType}");
                    BinaryPics.Add((buffer, imageFile.ContentType));
                    //var encoded = "data:image/png;base64," + Convert.ToBase64String(buffer);
                    //var encoded = "data:" + imageFile.ContentType + ";base64," + Convert.ToBase64String(buffer);
                    //Pics.Add(encoded);
                }
                //Messages.Add($"Time to encode images {sw.ElapsedMilliseconds}ms size:{useFile.Size}");
            }
        }
        int count = 0;
        
        var result = await BlobDb.OpenIndexedDb();
        var res2 = await BlobDb.DeleteAll("BlobStore");
        //sw.Restart();
        //foreach (var pic in Pics)
        //{
         //   count++;
         //   var newres = BlobDb.AddBlobItem<string>("BlobStore",  pic, "",count.ToString());
        //}
        //Messages.Add($"Successfully saved {count} base64 encoded images in {sw.ElapsedMilliseconds} ms");
        sw.Restart();
        count = 0;
        foreach (var pic in BinaryPics)
        {
            count++;
            var newres = BlobDb.AddBlobItem<byte[]>("BlobStore", pic.Item1, pic.Item2, count.ToString()+"-binary");
        }
        Messages.Add($"Successfully saved {count} binary images in {sw.ElapsedMilliseconds} ms");
        if (SaveBase64)
        {
            count = 0;
            foreach (var pic in BinaryPics)
            {
                count++;
                var str = "data:image;base64," + System.Convert.ToBase64String(pic.Item1);
                var bytes = Encoding.ASCII.GetBytes(str);
                var newres = BlobDb.AddBlobItem<byte[]>("BlobStore", bytes, pic.Item2, count.ToString() + "-base64");
            }
            Messages.Add($"Successfully saved {count} base64 images in {sw.ElapsedMilliseconds} ms");
        }
    }

}




